<!DOCTYPE html> 
<html> 
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <title>Choropleth maps with D3, Python, and data from FRED</title>
  <!--[if lt IE 9]>
    <script src="https://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->

  <link rel="icon" href="favicon.png" />
  <link rel="apple-touch-icon-precomposed" href="apple-touch-icon.png" />

  <!--Bootstrap css -->
  <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css"/>
  <!-- Sticky footer  -->
  <link rel="stylesheet" type="text/css" href="/assets/css/sticky-footer-navbar.css" />
  <!--Main Heather Theme css -->
  <link rel="stylesheet" type="text/css" href="/assets/css/heather.css" />
  <!-- CSS for publication list -->
  <link rel="stylesheet" href="/assets/css/publications.css" type="text/css" />
  <link rel="stylesheet" href="/assets/css/posts.css" type="text/css" />
   <!-- CSS for Google Web Fonts -->
  <link href='https://fonts.googleapis.com/css?family=Merriweather:400,700' rel='stylesheet' type='text/css'>
  <!-- Google code prettify -->
  <!--
  <script src="/assets/js/run_prettify.js?skin=desert"></script>
  -->
  <script src="/assets/js/prettify.js"></script>
  <link rel="stylesheet" type="text/css" href="/assets/css/prettify.css" />
  <!--
  <link rel="stylesheet" type="text/css" href="/assets/css/prettify.css" />
 -->
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53244112-1', 'auto');
    ga('send', 'pageview');

  </script>

  <!-- Script to use LaTeX code with MathJax  -->
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- CSS for flaticons -->
  <link rel="stylesheet" type="text/css" href="/assets/css/flaticon.css"> 
  <!-- Script for jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <!-- Script for bootstrap js library -->
  <script src="/assets/js/bootstrap.min.js" type="text/javascript"></script>
  <!-- meta data -->
  <meta name="author" content="Rubén Hernández-Murillo">
  <meta name="description" content="Research, Writings + Code">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="canonical" href="https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/">
</head>
<body>

<header> 
  <!-- 	
  <h1 class="h2 m-0"><a href="https://rubenhm.org">rubenhm.org</a></h1>
  <p>Research, Writings + Code</p> 
  -->

  <!-- Bootstrap navbar -->
  <nav class = "navbar navbar-default navbar-fixed-top" role="navigation">
   <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
   	<div class = "navbar-header">
   		<button type="button"  class = "navbar-toggle" data-toggle = "collapse" data-target = "#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>  
   			<span class = "icon-bar"></span>
   			<span class = "icon-bar"></span>
   			<span class = "icon-bar"></span>
   		</button>
      <a class = "navbar-brand" href ="https://rubenhm.org">rubenhm.org</a>
    </div>
    
    <!-- Collect the nav links, forms, and other content for toggling -->
   	<div class ="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
 			<ul class ="nav navbar-nav navbar-right">
 				<li ><a href = "/">Home</a></li>
 				<li><a href = "/cv/">CV</a></li>
 				<li class ="dropdown">
 					<a href ="#" class = "dropdown-toggle" data-toggle ="dropdown">Research <b class="caret"></b></a>
 					<ul class = "dropdown-menu">
 						<li><a href="/pubs/journal_articles/">Journal articles</a></li>
 						<li><a href="/pubs/fed_pubs/">Fed Pubs</a></li>
 						<li><a href="/pubs/commentary/">Commentary</a></li>
 						<li><a href="/pubs/working_papers/">Working papers</a></li>
 					</ul>
 				</li> 
 				<li><a href="/blog/">Blog</a></li>
        <li><a href="/news/">News</a></li>
        <li><a href="/about/">About</a></li>
 			</ul>
   	</div><!-- /.navbar-collapse -->
 </div><!-- /.container-fluid -->
</nav>	

</header>  

<div class="container">
    <div class="visible-print"> <!--Header for print version -->
            <h1 class="text-left">https://rubenhm.org/blog/</h1>
            <p class="lead text-left">Research, Writings + Code</p>
            <hr>
    </div>
        
    <h1><em>Coding Annoyances</em></h1>
        <hr>    
    <h1>Choropleth maps with D3, Python, and data from FRED</h1>
  
    <p class="small gray"><time datetime="Jul 6, 2016">06 July 2016 • Rubén Hernández-Murillo • </time></p>
    <hr>
    <article class="post">

        <p>I often need to create simple thematic maps of the Fourth <a href="https://en.wikipedia.org/wiki/Federal_Reserve_Bank">Federal Reserve District</a>, for example of the unemployment rate by county. The data are readily available from <a href="https://fred.stlouisfed.org">FRED</a>, but using ArcView is no fun.  </p>

<p>I found a nice tutorial by <a href="http://flowingdata.com/2009/11/12/how-to-make-a-us-county-thematic-map-using-free-tools/">Nathan Yau</a> that showed how to edit an SVG map with IPython using BeautifulSoup, but it required to have an SVG map to work with already.  </p>

<p>Then I found another tutorial by <a href="https://bost.ocks.org/mike/map/">Mike Bostock</a> that uses <a href="http://d3js.org">D3</a> and <a href="https://github.com/mbostock/topojson">TopoJSON</a> to generate the SVG map from a script. Mike Bostock&#39;s multiple <a href="https://bl.ocks.org/mbostock">examples pages</a> provide tutorials for generating and manipulating all kinds of maps.  </p>

<p>My map is based on the example for a simple Choropleth map of <a href="https://bl.ocks.org/mbostock/3306362">unemployment rates with thresholds</a> and the example that uses a <a href="https://bl.ocks.org/mbostock/5416405">selection of geographic units</a>.</p>

<h2>Map</h2>

<p>The Fourth Federal Reserve District includes all of Ohio, counties in eastern Kentucky, counties in western Pennsylvania, and a few counties in the northern section of West Virginia that lies between Ohio and Pennsylvania.</p>

<p>Here is the final result:</p>

<div class="map-container">
  <iframe src="/downloads/blog/2016-07-06-choropleth-maps-with-d3-python-and-data-from-fred/d4urmap.html" frameborder="0" allowfullscreen marginwidth="0" marginheight="0" style="height:600px;" scrolling="no">
  </iframe>
</div>

<div class="index-pop">
    <a target="_blank" title="Open map in a new window." href="/downloads/blog/2016-07-06-choropleth-maps-with-d3-python-and-data-from-fred/d4urmap.html">Open<svg height="16" width="12"><path d="M11 10h1v3c0 0.55-0.45 1-1 1H1c-0.55 0-1-0.45-1-1V3c0-0.55 0.45-1 1-1h3v1H1v10h10V10zM6 2l2.25 2.25-3.25 3.25 1.5 1.5 3.25-3.25 2.25 2.25V2H6z"></path></svg></a>
</div>

<h2>Steps</h2>

<ol>
<li>Create a file with the definition of the selection.<br></li>
<li>Obtain data for each county from FRED.</li>
<li>Create the map.</li>
</ol>

<h3>Geographic definition</h3>

<p>My file <a href="/downloads/blog/2016-07-06-choropleth-maps-with-d3-python-and-data-from-fred/d4ctydef.csv">d4ctydef.csv</a> is a comma-delimited file with the <a href="http://www.census.gov/geo/reference/codes/cou.html">FIPS</a> codes of the counties in the District.</p>
<div class="highlight"><pre><code class="language-" data-lang="">STATE,STATE_FIPS,FIPS,COUNTY_NAME,D4
KY,"21","21001",Adair County,FALSE
KY,"21","21003",Allen County,FALSE
KY,"21","21005",Anderson County,FALSE
KY,"21","21007",Ballard County,FALSE
KY,"21","21009",Barren County,FALSE
KY,"21","21011",Bath County,TRUE
KY,"21","21013",Bell County,TRUE
KY,"21","21015",Boone County,TRUE
KY,"21","21017",Bourbon County,TRUE
...
</code></pre></div>
<h3>Downloading data from FRED</h3>

<p>Automated downloading of data from FRED requires an API key and signing up for the service. 
Install the <code>fredapi</code> Python module from <a href="https://github.com/mortada/fredapi">https://github.com/mortada/fredapi</a>.
Now try the following in a Jupyter or IPython notebook.</p>

<figure class="highlight"><pre><code class="language-ipy" data-lang="ipy"># Import fredapi module
from fredapi import Fred
# Apply your personal api key
fred = Fred(api_key='abcdefghijklmnopqrstuv0123456789')

# Import pandas
import pandas as pd

# Get information on realease=116, which includes data on Unemployment in States and Local Areas
df = fred.search_by_release(116)
df['title'].head(10) # df has information on 6,000+ series

# Restrict information to the unemployment series
state_df = df[df['title'].str.startswith('Unemployment Rate in')]

# Create a column with states by selecting the first two letters of the index, series id
# The following commands throw up an error/warning but it works
state_df['state'] = state_df.apply(lambda row: row.id[:2], axis=1)

# Restrict further to the states in the Fourth District
d4_states = state_df[state_df.state.isin(['OH','KY','PA','WV'])]

# Read District definitions to a pandas dataframe
d4def = pd.read_csv('../data/d4ctydef.csv')

# Select District counties only using the boolean variable d4def.D4
d4strict = d4def[d4def["D4"]]

# Search for county names in Fred series to obtain series id
d4_states.loc[d4_states["title"].str.contains("Adair County"),"id"]

# Get FRED id of unemployment series if county is in the District and create 
# a dictionary with county fips, county name, and FRED id
d4_county_series = {}
for row in d4strict.itertuples():
        state,fips,county = row[1],row[3],row[4]
        seriesid = d4_states.loc[d4_states["id"].str.startswith(state) &amp; d4_states["title"].str.contains(county)]['id']
        d4_county_series[fips] = [seriesid[0], county + ', ' + state, '"' + str(fips) + '"']

# Download the latest observation for each county and create 
# a dictionary of FRED id, county fips, county name, and unemployment rate
end_time = max(d4_states.observation_end)
d4_cty_ur = {}
for fips, dictitem in d4_county_series.iteritems():
    seriesid, county, cty_fips = dictitem
    d4_cty_ur[fips] = [fips, county, fred.get_series(seriesid, observation_start=end_time, observation_end=end_time)[0]]

# Write dictionary to tab-delimited file with header
with open('urd4.tsv', 'w') as f:
    f.write('id\tcounty\trate\n')
    [f.write('"{0}"\t"{1}"\t{2}\n'.format(fips, county, rate)) for key, [fips, county, rate] in d4_cty_ur.items()]</code></pre></figure>

<p>The file <a href="/downloads/blog/2016-07-06-choropleth-maps-with-d3-python-and-data-from-fred/urd4.tsv">urd4.tsv</a> looks like this:</p>
<div class="highlight"><pre><code class="language-" data-lang="">id  county  rate
"21165" "Menifee County, KY"    8.0
"21011" "Bath County, KY"   6.6
"21013" "Bell County, KY"   8.4
"21015" "Boone County, KY"  3.7
"21017" "Bourbon County, KY"    4.6
"21019" "Boyd County, KY"   7.5
"21023" "Bracken County, KY"    5.7
...
</code></pre></div>
<p>Determine natural breaks in the data using the python module <code>jenks</code> from <a href="https://github.com/perrygeo/jenks">https://github.com/perrygeo/jenks</a>.</p>

<figure class="highlight"><pre><code class="language-ipy" data-lang="ipy"># Determine cutoffs for choropleth map
from jenks import jenks

# Create list from dictionary and obtain cutoffs
# http://stackoverflow.com/questions/16228248/python-simplest-way-to-get-list-of-values-from-dict
values = [ d4_cty_ur[key][2] for key in d4_cty_ur] 
cutoffs = jenks(values,4)
print cutoffs
[2.9000001, 4.8000002, 6.4000001, 8.3999996, 15.6]</code></pre></figure>

<h2>Create the map</h2>

<p>The TopoJSON file for the US corresponds to the file <code>topo/us-10m.json</code> and is generated according to the instructions in Mike Bostock&#39;s repository for the <a href="https://github.com/mbostock/us-atlas">US-Atlas</a>.</p>

<p>Finally, the code for the SVG map is as follows:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="c">&lt;!-- This maps uses bits and pieces from multiple Mike Bostock's examples, including: 
  https://bl.ocks.org/mbostock/5737662 
  https://bl.ocks.org/mbostock/9943478
  https://bl.ocks.org/mbostock/9943478
  http://bl.ocks.org/mbostock/4090848
--&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;style&gt;</span>

<span class="c">/* CSS goes here. */</span>
<span class="nt">path</span> <span class="p">{</span>
  <span class="py">stroke-linejoin</span><span class="p">:</span> <span class="n">round</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* This is style for the different thresholds. */</span>
<span class="nc">.colour1</span> <span class="p">{</span><span class="py">fill</span><span class="p">:</span> <span class="m">#f2f0f7</span><span class="p">;}</span>
<span class="nc">.colour2</span> <span class="p">{</span><span class="py">fill</span><span class="p">:</span> <span class="m">#dadaeb</span><span class="p">;}</span>
<span class="nc">.colour3</span> <span class="p">{</span><span class="py">fill</span><span class="p">:</span> <span class="m">#bcbddc</span><span class="p">;}</span>
<span class="nc">.colour4</span> <span class="p">{</span><span class="py">fill</span><span class="p">:</span> <span class="m">#9e9ac8</span><span class="p">;}</span>
<span class="nc">.colour5</span> <span class="p">{</span><span class="py">fill</span><span class="p">:</span> <span class="m">#756bb1</span><span class="p">;}</span>

<span class="nc">.label</span> <span class="p">{</span>
  <span class="nl">font-family</span><span class="p">:</span> <span class="n">Verdana</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.d4-county</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.3</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.counties</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="m">#ccc</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.county-boundary</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="py">stroke</span><span class="p">:</span> <span class="m">#777</span><span class="p">;</span>
  <span class="py">stroke-width</span><span class="p">:</span> <span class="m">.35px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.d4-county-boundary</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="py">stroke</span><span class="p">:</span> <span class="m">#145eda</span><span class="p">;</span>
  <span class="py">stroke-width</span><span class="p">:</span> <span class="m">2px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.state-boundary</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
  <span class="py">stroke</span><span class="p">:</span> <span class="no">white</span><span class="p">;</span>
  <span class="py">stroke-width</span><span class="p">:</span> <span class="m">2px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//d3js.org/d3.v3.min.js"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//d3js.org/queue.v1.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"//d3js.org/topojson.v1.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>

<span class="cm">/* JavaScript goes here. */</span>

<span class="cm">/* These constraints on width and height produce a nice squarish size. */</span>
<span class="kd">var</span> <span class="nx">width</span>  <span class="o">=</span> <span class="mi">960</span><span class="o">*</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="nx">height</span> <span class="o">=</span> <span class="mi">500</span><span class="o">*</span><span class="mf">1.2</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">formatNumber</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">",.1f"</span><span class="p">);</span> 

<span class="cm">/* The thresholds are hardcoded here. The jenks breaks are rounded some. */</span>
<span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">threshold</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s2">"#f2f0f7"</span><span class="p">,</span> <span class="s2">"#dadaeb"</span><span class="p">,</span> <span class="s2">"#bcbddc"</span><span class="p">,</span> <span class="s2">"#9e9ac8"</span><span class="p">,</span> <span class="s2">"#756bb1"</span><span class="p">,</span> <span class="s2">"#54278f"</span><span class="p">]);</span>

<span class="cm">/* I played around with the projection options to limit the view to the Fourth District. */</span>
<span class="kd">var</span> <span class="nx">projection</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albers</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">center</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mf">39.43</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">rotate</span><span class="p">([</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">parallels</span><span class="p">([</span><span class="mf">29.5</span><span class="p">,</span> <span class="mf">45.5</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="mi">5800</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">translate</span><span class="p">([</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]);</span>

<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">path</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">projection</span><span class="p">(</span><span class="nx">projection</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">"body"</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">"svg"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"width"</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"height"</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>

<span class="cm">/* Here is the selection of counties in the Fourth District. */</span>
<span class="kd">var</span> <span class="nx">selected</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"21011"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21013"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21015"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21017"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21019"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21023"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21025"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21037"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21043"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21049"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21051"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21063"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21065"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21067"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21069"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21071"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21079"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21081"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21089"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21095"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21097"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21109"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21113"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21115"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21117"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21119"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21121"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21125"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21127"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21129"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21131"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21133"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21135"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21137"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21147"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21151"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21153"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21159"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21161"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21165"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21173"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21175"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21181"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21189"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21191"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21193"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21195"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21197"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21199"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21201"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21203"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21205"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21209"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21235"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21237"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"21239"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39001"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39003"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39005"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39007"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39009"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39011"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39013"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39015"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39017"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39019"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39021"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39023"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39025"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39027"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39029"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39031"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39033"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39035"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39037"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39039"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39041"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39043"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39045"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39047"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39049"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39051"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39053"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39055"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39057"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39059"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39061"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39063"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39065"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39067"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39069"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39071"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39073"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39075"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39077"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39079"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39081"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39083"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39085"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39087"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39089"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39091"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39093"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39095"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39097"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39099"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39101"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39103"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39105"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39107"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39109"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39111"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39113"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39115"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39117"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39119"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39121"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39123"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39125"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39127"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39129"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39131"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39133"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39135"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39137"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39139"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39141"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39143"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39145"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39147"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39149"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39151"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39153"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39155"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39157"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39159"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39161"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39163"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39165"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39167"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39169"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39171"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39173"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"39175"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42003"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42005"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42007"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42019"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42031"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42039"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42049"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42051"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42053"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42059"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42063"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42065"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42073"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42085"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42111"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42121"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42123"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42125"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"42129"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"54009"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"54029"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"54051"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"54069"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"54095"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s2">"54103"</span><span class="p">:</span> <span class="mi">1</span><span class="p">};</span>

<span class="cm">/* Loading the JSON and unemployment data. */</span>

<span class="nx">queue</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">,</span> <span class="s2">"us.json"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">tsv</span><span class="p">,</span> <span class="s2">"urd4.tsv"</span><span class="p">)</span>
    <span class="p">.</span><span class="kr">await</span><span class="p">(</span><span class="nx">ready</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">ready</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">us</span><span class="p">,</span> <span class="nx">unemployment</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">cutoffs</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">]</span>
  <span class="kd">var</span> <span class="nx">rateById</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">nameById</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="nx">unemployment</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="nx">rateById</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="nx">d</span><span class="p">.</span><span class="nx">rate</span><span class="p">;</span> <span class="p">})</span>
  <span class="nx">unemployment</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="nx">nameById</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span>  <span class="nx">d</span><span class="p">.</span><span class="nx">county</span><span class="p">;</span> <span class="p">})</span>

  <span class="kd">var</span> <span class="nx">counties</span> <span class="o">=</span> <span class="nx">topojson</span><span class="p">.</span><span class="nx">feature</span><span class="p">(</span><span class="nx">us</span><span class="p">,</span> <span class="nx">us</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">counties</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">selection</span> <span class="o">=</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s2">"FeatureCollection"</span><span class="p">,</span> <span class="na">features</span><span class="p">:</span> <span class="nx">counties</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">;</span> <span class="p">})</span>
     <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">exselection</span> <span class="o">=</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s2">"FeatureCollection"</span><span class="p">,</span> <span class="na">features</span><span class="p">:</span> <span class="nx">counties</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">);</span> <span class="p">})</span>
     <span class="p">};</span>

<span class="c1">// Create path for Counties outside selection</span>
  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">exselection</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"counties"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>

  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">topojson</span><span class="p">.</span><span class="nx">mesh</span><span class="p">(</span><span class="nx">us</span><span class="p">,</span> <span class="nx">us</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">counties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">!==</span> <span class="nx">b</span> <span class="c1">// a border between two counties</span>
            <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="mi">53000</span> <span class="o">||</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="mi">5300</span> <span class="c1">// where a and b are in puget sound</span>
              <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// or a and b are not in a lake</span>
            <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">^</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// and a and b are in the same state</span>
            <span class="o">&amp;&amp;</span> <span class="p">(</span>
               <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span>  <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="p">)</span>
            <span class="p">);</span> 
      <span class="p">}))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"county-boundary"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>

<span class="c1">// Create path for Counties inside selection</span>
<span class="c1">// Here the counties are color-coded according to their unemployment rate.</span>

  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"g"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">selection</span><span class="p">.</span><span class="nx">features</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"d4-county"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> 
           <span class="k">return</span> <span class="s2">"F"</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="p">;}</span>
             <span class="p">)</span>
         <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">"fill"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">color</span><span class="p">(</span><span class="nx">rateById</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span> <span class="p">})</span>
         <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"title"</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">nameById</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">+</span> <span class="s2">" (FIPS: "</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">")"</span>
            <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Unemployment rate: "</span> <span class="o">+</span> <span class="nx">formatNumber</span><span class="p">(</span><span class="nx">rateById</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"%"</span><span class="p">;</span> <span class="p">});</span>

  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">topojson</span><span class="p">.</span><span class="nx">mesh</span><span class="p">(</span><span class="nx">us</span><span class="p">,</span> <span class="nx">us</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">counties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">!==</span> <span class="nx">b</span> <span class="c1">// a border between two counties</span>
            <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="mi">53000</span> <span class="o">||</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="mi">5300</span> <span class="c1">// where a and b are in puget sound</span>
              <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// or a and b are not in a lake</span>
            <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">^</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="c1">// and a and b are in the same state</span>
            <span class="o">&amp;&amp;</span> <span class="p">(</span>
               <span class="p">(</span>  <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span>  <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">selected</span><span class="p">)</span> <span class="p">)</span>
            <span class="p">);</span> 
      <span class="p">}))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"d4-county-boundary"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>

<span class="c1">// Create path for State boundaries</span>

  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">topojson</span><span class="p">.</span><span class="nx">mesh</span><span class="p">(</span><span class="nx">us</span><span class="p">,</span> <span class="nx">us</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">states</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> 
         <span class="k">return</span> <span class="nx">a</span> <span class="o">!==</span> <span class="nx">b</span> <span class="p">;</span> <span class="c1">// a and b not in selection//</span>
        <span class="p">}))</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"state-boundary"</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"d"</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>

<span class="c1">// Add labels and color guide</span>
  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"g"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"label"</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"keycolor"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">"rect"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"rect"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span> <span class="mi">450</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"y"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="mi">350</span> <span class="o">+</span> <span class="nx">d</span><span class="o">*</span><span class="mi">25</span><span class="p">;</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"width"</span><span class="p">,</span> <span class="mi">20</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"height"</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="s2">"key colour"</span> <span class="o">+</span> <span class="nx">d</span> <span class="p">;});</span>

  <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"g"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"class"</span><span class="p">,</span> <span class="s2">"label"</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"keytext"</span><span class="p">)</span> 
    <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">"text"</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"text"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"x"</span><span class="p">,</span> <span class="mi">475</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">"y"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="mi">365</span> <span class="o">+</span> <span class="nx">d</span><span class="o">*</span><span class="mi">25</span><span class="p">;</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> 
          <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span><span class="k">return</span> <span class="s2">"0.0 to "</span> <span class="o">+</span> <span class="nx">formatNumber</span><span class="p">(</span><span class="nx">cutoffs</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"%"</span><span class="p">}</span>
          <span class="k">else</span>
            <span class="p">{</span><span class="k">return</span> <span class="nx">formatNumber</span><span class="p">(</span><span class="nx">cutoffs</span><span class="p">[</span><span class="nx">d</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">" to "</span> <span class="o">+</span> <span class="nx">formatNumber</span><span class="p">(</span><span class="nx">cutoffs</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="o">+</span> <span class="s2">"%"</span> <span class="p">}</span>
          <span class="p">;});</span>

<span class="p">}</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">frameElement</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">"height"</span><span class="p">,</span> <span class="nx">height</span> <span class="o">+</span> <span class="s2">"px"</span><span class="p">);</span>

<span class="nt">&lt;/script&gt;</span>
</code></pre></div>

    </article>
    <hr>
        <div class="row hidden-print">
        <div class="col-md-6">
            <p>If you enjoyed this article, consider sharing it.</p>
            <p><a href="https://twitter.com/intent/tweet?text=Choropleth maps with D3, Python, and data from FRED&url=https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/&via=rubenhm_org" title="Share link on Twitter"><span class="flaticon-social19"></span></a>
            <a  href="https://plus.google.com/share?url=https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/" title="Share link on G+"><span class="flaticon-google23"></span></a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/" title="Share link on FB"><span class="flaticon-facebook29"></span></a>
            <a href="mailto:?Subject=Choropleth maps with D3, Python, and data from FRED&amp;Body=https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/" title="Share link by email"><span class="flaticon-opened4"></span></a>
            <a href="/downloads/blog/2016-07-06-choropleth-maps-with-d3-python-and-data-from-fred/2016-07-06-choropleth-maps-with-d3-python-and-data-from-fred.pdf" title="Download PDF"><span class="flaticon-adobe21"></span></a></p>
            
            <!-- <a><span class="flaticon-printer70"></span></a> -->
        </div>
        <div class="col-md-6">
            <p>Follow for updates.</p>
            <p><a href="/feed.xml" title="Subscribe to Blog Feed"><span class="flaticon-rss8"></span></a> 
            <a href="https://twitter.com/intent/follow?screen_name=rubenhm_org" title="Follow on Twitter"><span class="flaticon-social19"></span></a></p>
        </div>
    </div>
    <hr>

    <div class="visible-print">
            <p><small>Follow for updates.</small></p>
            <p><a href="https://rubenhm.org/feed.xml" title="Subscribe to Blog Feed"><span class="flaticon-rss8"></span></a> 
            <span class="flaticon-social19"></span> @rubenhm_org</a></p>
            <hr>
    </div>
    <div class="hidden-print">
        <h2>Comments section</h2>
        <div class="alert alert-info" role="alert"> 
        <p><span class="flaticon-info12"></span> <strong>Rules:</strong> This forum is intended for a collegial discussion on economics and research tools. <br/>
            All comments will be initially withheld and promptly moderated prior to posting. Comments will be posted if they are done in a respectful and courteous manner.  
            We reserve the right to remove or not publish inappropriate comments.</p>
        </div>
   
        <hr>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'rubenhm'; // required: replace example with your forum shortnam
        var disqus_identifier = '/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/';
        var disqus_url = 'https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">   comments powered by Disqus.</a></noscript>
    <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rubenhm'; // required: replace example with your forum shortname
    var disqus_identifier = '/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/';
    var disqus_url = 'https://rubenhm.org/blog/2016/07/06/choropleth-maps-with-d3-python-and-data-from-fred/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    
<!-- Script to fix <pre> tag to highlight code -->
<script type="text/javascript">
    $(document).ready(function(){
    $("pre").addClass("prettyprint linenums");
     prettyPrint();
});
</script>
</body>
</html>
